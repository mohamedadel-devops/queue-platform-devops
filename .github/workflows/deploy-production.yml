name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Commit SHA tag to deploy (from a successful CI run)"
        required: true

env:
  API_IMAGE: node-queue-api
  WORKER_IMAGE: node-queue-worker
  API_PORT: "3001"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout (GitHub Action)
        uses: actions/checkout@v4

      - name: Deploy to Production (bash + ssh + docker compose)
        env:
          HOST: ${{ secrets.PRODUCTION_HOST }}
          USER: ${{ secrets.EC2_USER }}
          KEY:  ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          NS:   ${{ secrets.DOCKERHUB_NAMESPACE }}
          TAG:  ${{ inputs.image_tag }}
        run: |
          set -e

          mkdir -p ~/.ssh
          echo "$KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          COMPOSE_CONTENT="$(cat app/compose/docker-compose.production.yml)"

          ssh -o StrictHostKeyChecking=no $USER@$HOST "
            set -e
            mkdir -p ~/queue-platform && cd ~/queue-platform

            PREV_TAG=''
            if docker ps --format '{{.Names}}' | grep -q '^api_production$'; then
              PREV_IMAGE=\$(docker inspect -f '{{.Config.Image}}' api_production || true)
              PREV_TAG=\$(echo \"\$PREV_IMAGE\" | awk -F: '{print \$2}')
            fi

            cat > .env <<EOF
            DOCKERHUB_NAMESPACE=$NS
            API_IMAGE=$API_IMAGE
            WORKER_IMAGE=$WORKER_IMAGE
            IMAGE_TAG=$TAG
            EOF

            cat > docker-compose.production.yml <<'EOF'
          $COMPOSE_CONTENT
          EOF

            docker compose -f docker-compose.production.yml pull
            docker compose -f docker-compose.production.yml up -d

            OK=0
            for i in {1..15}; do
              if curl -fsS http://localhost:${API_PORT}/health >/dev/null; then OK=1; break; fi
              sleep 2
            done

            if [ \"\$OK\" = \"1\" ]; then
              echo 'Healthcheck OK'
              docker image prune -f
              exit 0
            fi

            echo 'Healthcheck FAILED - rollback'
            if [ -n \"\$PREV_TAG\" ]; then
              cat > .env <<EOF
            DOCKERHUB_NAMESPACE=$NS
            API_IMAGE=$API_IMAGE
            WORKER_IMAGE=$WORKER_IMAGE
            IMAGE_TAG=\$PREV_TAG
            EOF
              docker compose -f docker-compose.production.yml pull
              docker compose -f docker-compose.production.yml up -d
            fi
            exit 1
          "

